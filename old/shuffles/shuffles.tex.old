In a NIZK Shuffle argument one wants to prove that two vectors of ciphertexts open to the same values when second vector is permuted under some hidden permutation.
The language of correct shuffles of El-Gamal cyphertexts under public key $[\vecb{u}]_1\in\GG^2_1$ can can be defined as follows:
$$
\Lang_{[\matr{u}]_1,n,\mathsf{shuffle}}:=\{([\matr{C}]_1,[\matr{D}]_1)\in\GG_1^{2\times n}\times \GG_1^{2\times n} : \exists \matr{P}\in\mathcal{S}_n,\grkb{\delta}\in\Z_q^n \text{ s.t. } [\matr{C}]_1\matr{P}-[\matr{D}]_1 = [\vecb{u}]_1\grkb{\delta}^\top\},$$
where $\mathcal{S}_n$ is the set of permutation matrices of size $n\times n$. This definition can be generlized for any ``El-Gamal like'' encryption scheme as, for example, the BBS encryption scheme from \cite{C:BonBoySha04}.

The most efficient NIZK Shuffle argument under falsifiable assumptions is the one from Groth and Lu \cite{AC:GroLu07}, which works for BBS cyphertexts. The proof size is linear in the number of ciphertexts and the security of their construction relies on two assumptions: the \emph{Paring Product Assumption} and the \emph{Permutation Pairing Assumption}. The first assumption is a $\dist_{2,n}\mbox{-}\kermdh$ Assumption, where $\matr{M}\gets\dist_{2,n}$ is of the form $\matr{M}:=\pmatri{x_1,\ldots,x_n\\x_1^2,\ldots,x_n^2}$ for $x_i\gets\Z_q$, $i\in[n]$. The second assumption is proven generically secure in \cite{AC:GroLu07} but it seems to be unrelated with any other assumption.

We construct a NIZK Shuffle argument with the same asymptotic proof size but whose security is based on assumptions which are weaker than the \ddh~plus the \SSDP~Assumption. For a fair comparison, note that Groth and Lu's construction works only in Symmetric Groups and, in such a case, our construction can be based on assumptions which are all weaker than \lin{2}.\footnote{In the symmetric case, the proof system from Sect. \ref{sec:bits} can be based on assumptions which are all weaker than $\lin{2}$, similarly as done in XXX Appendix XXX} We motivate our construction with the following observation about permutation matrices

\textbf{Observation.} The matrix $\matr{P}\in\Z_q^{n\times n}$ is a permutation matrix if and only if
\begin{enumerate}
    \item $\matr{P}\in\bits^{n\times n}$.
    \item $\matr{1}_{1\times n}\matr{P}=\matr{1}_{1\times n}$.
    \item $\matr{P}\matr{1}_{n\times 1}= \matr{1}_{n\times 1}$.
\end{enumerate}

Given coordinate-wise GS commitment to $\matr{P}$, satisfiability of equations implied by 1,2 and 3, imply that $\matr{P}$ is permutation matrix. However, only commitments to $\matr{P}$ requires $\Theta(n^2)$ group elements. Below we describe an alternative way to commit to $\matr{P}$ using only $\Theta(n)$ group elements.

Given GS commitment key $[\matr{V}]_2\in\GG_2^{2\times 2}$ and some list $L$ of size $n$ to be defined later, the proof system from Sect. \ref{sec:list-memb} allows to prove that a matrix $[\Lcom]_2\in\GG_2^{2\times n}\in\Lang_{[\matr{V}]_2,L,n}$. That is, there exists sombre matrix $\matr{R}\in\Z_q^{2\times n},\matr{B}\in\bits^{n\times n}$ (i.e. $m:=n$) such that $\matr{1}_{1\times n}\matr{B}=\matr{1}_{1\times n}$ and $[\Lcom]_2 = [\matr{L}]_2\matr{B}+[\matr{V}]_2\matr{R}$. If we think of $[\Lcom]_2$ as a commitment to $\matr{P}:=\matr{B}$, the proof system from Sect. \ref{sec:list-memb} allows to prove statements 1 and 2. The natural way to prove statement 3 should be
to prove that $
[\Lcom]_2\matr{1}_{n\times 1}-[\matr{L}]_2\matr{1}_{n\times 1} = [\matr{V}]_2\grkb{\gamma}
$, for some $\grkb{\gamma}\in\Z_q^2$, which implies that $[\matr{L}]_2(\matr{P}\matr{1}_{n\times 1}-\matr{1}_{n\times 1})=0$. If we define $L:=\{[a_1]_2,\ldots,[a_n]_2\}$, where $\vecb{a}\gets \dist_{n,1}$ and the $\dist_{n,1}\mbox{-}\kermdh$ problem is hard, then $\matr{P}\matr{1}_{n\times 1}=\matr{1}_{n\times 1}$, unless one can find a solution to the $\dist_{n,1}\mbox{-}\kermdh$ Assumption We conclude that $\matr{P}$ is a permutation matrix.

Now, given $([\matr{C}]_1,[\matr{D}]_1)\in\GG^{2\times n}\times\GG_1^{2\times n}$ and $[\Lcom]_2$, which defines a GS commitment to $\varvecx:=[\vecb{a}]_2\matr{P}^\top$, we show with a GS proof the satisfiability of
\begin{equation}
\dfrac{e([\matr{C}]_1,\varvecx^\top)}{e([\matr{D}]_1,[\vecb{a}]_2^\top)}
=
e([\vecb{u}]_1,\mathsf{y}),
\label{eq:shuffle}
\end{equation}
fro some $\mathsf{y}\in\GG_2$.

We briefly comment why this imply soundness. Given $\vecb{u}$, one can compute $\vecb{k}\in\Z_q^2$ such that $\vecb{k}^\top[\matr{C}]_1=[\vecb{m}]_1\in\GG_1^{1\times n}$, and $\vecb{k}^\top[\matr{D}]_1=[\vecb{m}']_1\in\GG_1^{1\times n}$, the decryptions of $[\matr{C}]_1$ and $[\matr{D}]_1$, and $\vecb{k}^\top[\vecb{u}]_1=[\vecb{0}]_1$.\footnote{In the Quasi-Adaptive setting, we prove membership in the CRS dependent language $\Lang_{\hvecb{u},n,\mathsf{shuffle}}$. This allows us to decrypt the ciphertexts in the soundness game, using the discrete logarithm of $\hvecb{u}$. Similarly, Groth and Lu proved \emph{co-soundness}, which requires the adversary to provide the decryption key.} If we multipliy Eq. \ref{eq:shuffle} by $\vecb{k}^\top$ on the right we get
$$
e([\vecb{m}]_1\matr{P}^\top-[\vecb{m}']_1,[\vecb{a}]_2^\top)=1,
$$
which implies that $([\matr{C}]_1,[\matr{D}]_1)\in\Lang_{[\vecb{u}]_1,n,\mathsf{shuffle}}$, unless $[\vecb{m}]_1\matr{P}^\top-[\vecb{m}']_1$ is a solution to the $\dist_{n,1}\mbox{-}\kermdh$ Assumption.

\input{shuffles/detailed-description}

Figure \ref{fig:shuffles} provides detailed description of the proof system for $\Lang_{[\vecb{u}]_1,n,\mathsf{shuffle}}$.


%\textbf{Comparison with Groth and Lu's construction}
%Let $[\matr{V}]_2=\in\GG_2^{2\times (n+1)}$ the commitment keys GS commitments and let $[(a_1,\ldots,a_n)]_2\gets\distlin_{1,n}$ and let $\matr{A} = \pmatri{a_1 & \ldots & a_n\\0 &\ldots & 0}$. We commit to $P$ with the matrix of GS commitments $[\matr{D}]_2=[\matr{A}]_2\matr{P}+[\matr{V}]_2\matr{R}$, $\matr{R}\gets\Z_q^{2\times n}$. By analogy, given $[\matr{D}]_2$, one would like to prove that
% \begin{enumerate}
%    \item Commitment $[\vecb{d}_i]_2$ opens to a value in the list $\{[a_1]_2,\ldots,[a_{n}]_2\}$.
%    \item $[\matr{D}]_2\matr{1}_{n\times1}=[\matr{H}_1]_2\matr{1}_{n\times 1} + [\matr{V}]_2\grkb{\gamma}$, for some $\grkb{\gamma}\in\Z_q^2$.
%\end{enumerate}
%
%For the first point we use the proof system from Sect. \ref{sec:list-memb} for $[\matr{L}]_2 = [\matr{A}]_2$. That is, we show that there is some matrix $\matr{B}\in\bits^{n\times n}$ such that $\matr{1}_{1\times n}\matr{B}=\matr{1}_{1\times n}$ and $[\matr{D}]_2 = [\matr{A}]_2\matr{B}+[\matr{V}]_2\matr{R}$. Note that $\matr{B}$ can be extracted from $[\matr{D}]_2$ using the discrete log of $[\matr{V}]_2$. Statement 2 implies that $[(a_1,\ldots,a_n)](\matr{B}\matr{1}_{1\times n}-\matr{1}_{n\times 1})=\matr{0}$ and, if $\matr{B}\matr{1}_{1\times n}\neq\matr{1}_{n\times 1}$, then $\matr{B}\matr{1}_{1\times n}-\matr{1}_{n\times 1}$ is a solution to the $\distlin_{1,n}\mbox{-}\kermdh$ Assumption. We conclude that $\matr{B}$ is necesarily a matrix permutation.
%
%
%Using a similar construction to the one of Groth and Lu combined with our techniques, we construct a Proof of a Shuffle with the same asymptotic proof size but whose security is based on assumptions which are weaker than the \ddh~plus the \SSDP~Assumption. For a fair comparison, note that Groth and Lu's construction works only in Symmetric Groups and, in such a case, our construction can be based on assumptions which are all weaker than \lin{2}. 
%


%The proof system is as follows. Pick $\vecb{a}\gets\distlin_n$, pick an ElGamal public key $\hvecb{u}\gets\distlin_2$, and pick  perfectly binding commitment keys $\cmatr{V}\in\Hr^{2\times2}$. The CRS is formed by $\cvecb{a},\hvecb{u},\cmatr{V}$ and another CRS for aggregated proofs of membership in the list $\{\hat{a}_1,\ldots,\hat{a}_n\}$. Given ElGamal ciphertexts $\hvecb{c}_1,\ldots,\hvecb{c}_n$, $\hvecb{d}_1,\ldots,\hvecb{d}_n$, and $\grkb{\delta}\in\Z_q$ and $\pi\in S_n$, such that $\hvecb{c}_i-\hvecb{d}_{\pi(i)} = \delta_i\hvecb{u}$ for all $i\in[n]$, the prover computes commitments $\cvecb{f}_i \gets \iota_2(\hat{a}_{\pi(i)})+\cmatr{V}\vecb{t}_i$, $\matr{t}_i\gets\Z_q^2$. Using our proofs from Sect. \ref{sec:extimprov} it shows that each commitment opens to an element in the list $\{\check{a}_1,\ldots,\check{a}_n\}$. Using GS proofs show that: a) $\sum_{i\in[n]}\check{a}_{\pi(i)}-\sum_{i\in[n]}\check{a}_i=0$ and that b) $\sum_{i\in[n]}\hvecb{c}_i\check{a}_{\pi(i)}-\sum_{i\in[n]}\hvecb{d}_i\check{a}_i = \hvecb{u}(\sum_{i\in[n]}\delta_i\check{a}_i)$. 
%%$\cgrkb{\theta} := \sum_{i\in[n]}{\delta}_i\iota_2(\check{a}_i)^\top$ and $\cmatr{\Pi}:=\sum_{i\in[n]}\hvecb{d}_i\vecb{t}_i^\top$, which are used by the verifier to check that
%\begin{equation}
%\sum_{i\in[n]}\hvecb{c}_i\iota_2(\check{a}_i)^\top-\sum_{i\in[n]}\hvecb{d}_i\cvecb{f}_i^\top=\hvecb{u}\cgrkb{\theta}^\top + \hmatr{\Pi}\cmatr{V}^\top.
%\label{eq:ver2}
%\end{equation}
%
%Now we briefly sketch the soundness proof. Let $\hat{m}_1,\ldots,\hat{m}_n$ and $\hat{m}'_1,\ldots,\hat{m}'_n$ the decryptions of $\hvecb{c}_1,\ldots,\hvecb{c}_n,\hvecb{d}_1,\ldots,\hvecb{d}_n$ respectively. If we assume that $\cvecb{f}_1,\ldots,\cvecb{f}_n$ are commitments to some permutation $\pi$ of $\cvecb{a}$, by b) and that ElGamal ciphertexts are perfectly binding, it must hold that $\sum_{i\in[n]}\check{a}_i(\hat{m}_{\pi^{-1}(i)}-\hat{m}_i')=0$, which implies that $(\hat{m}_{\pi^{-1}(1)}-\hat{m}'_1,\ldots,\hat{m}_{\pi^{-1}(n)}-\hat{m}'_n)^\top$ is a solution to the $\distlin_n\mbox{-}\kermdh$ Assumption.\footnote{In the Quasi-Adaptive setting, we prove membership in the CRS dependent language $\Lang_{\hvecb{u},\mathsf{shuffle}}:=\{(\hvecb{c},\hvecb{d}):\exists \pi\in S_n,\grkb{\delta}\in\Z_q^n \forall i\in[n]\ \hvecb{c}_i-\hvecb{d}_{\pi(i)}=\delta_i\hvecb{u}\}$. This allows us to decrypt the ciphertexts in the soundness game, using the discrete logarithm of $\hvecb{u}$. Similarly, Groth and Lu proved \emph{co-soundness}, which requires the adversary to provide the decryption key.}  Now is left to prove that $\cvecb{f}_1,\ldots,\cvecb{f}_n$ are commitments to a permutation of $\cvecb{a}$. Given that each $\cvecb{f}_i$ opens to an element from $\{\check{a}_1,\ldots,\check{a}_n\}$, it holds that $\sum_{i\in[n]}\cvecb{f}_i = \sum_{i\in[n]} \ell_i\iota_2(\check{a}_i)+\cmatr{V}\vecb{t}$, where each $\ell_i\in\Z_n$ and $\vecb{t}\in\Z_q^2$. Suppose that there is some $i\in[n]$ s.t. $\ell_i\neq 1$, then by a), $\sum_{i\in[n]}\check{a}_i(\ell_i-1)=0$ and thus $(\ell_1-1,\ldots,\ell_n-1)^\top$ is a solution to the $\distlin_n\mbox{-}\kermdh$ Assumption.
%
%\input{appendix/shuffles-full}
%\begin{figure} 
%$$
%\begin{array}{|l|l|l|}
%\hline
%\begin{array}{l}
%\algK_1(\Gamma,\hmatr{M},\cmatr{N},m,n) \quad  (\mathsf{S}_1(\Gamma,\hmatr{M},\cmatr{N},m,n))\\
%\hline
%\matr{A} \gets \widetilde{\dist_{k}}\\
%\matr{\Lambda} \gets \Z_q^{\tilde{k} \times m}, \matr{\Xi}\gets \Z_q^{\tilde{k}\times n}, \matr{Z} \gets \Z_q^{\tilde{k} \times t}\\
%\cmatr{A}_{\Lambda}:= \matr{\Lambda}^\top \cmatr{A}\\
%\hmatr{A}_{\Xi}:= \matr{\Xi}^\top\hmatr{A}\\
%\hmatr{M}_{\Lambda}:=\matr{\Lambda} \hmatr{M}+\hmatr{Z}\\
%\hmatr{N}_{\Xi}:=\matr{\Xi} \cmatr{N}-\cmatr{Z} \\
%\text{Return } \ \mathsf{crs}:=(\hmatr{M}_{\Lambda}, \cmatr{A}_\Lambda , \cmatr{A},\cmatr{N}_{\Xi},\\\hmatr{A}_{\Xi} , \hmatr{A}).\\
%(\tau_{sim}:=(\matr{\Lambda},\matr{\Xi}).)
%\\
%\end{array}
%&
%\begin{array}{l}
%{\algP(\mathsf{crs}, \hvecb{x}, \cvecb{y}, \vecb{w})}\\
%\hline
%\backslash \backslash (\hvecb{x}=\hmatr{M} \vecb{w}, \cvecb{y}=\cmatr{N} \vecb{w})
%\\
%\matr{z} \gets \Z_q^{\tilde{k}}\\
%\hgrkb{\rho}:=\hmatr{M}_{\Lambda} \vecb{w}+ \hvecb{z}\\
%\hgrkb{\sigma}:=\cmatr{N}_{\Xi} \vecb{w}- \cvecb{z}\\
% \text{Return } \  (\hgrkb{\rho},\cgrkb{\sigma}). \\ \\
%\hline
%{\algV(\mathsf{crs},(\hvecb{x},\cvecb{y}), (\hgrkb{\rho},\cgrkb{\sigma}))}\\
%\hline
%\text{Return } \ (\hvecb{x}^\top \cmatr{A}_\Lambda  - \hgrkb{\rho}^\top\cmatr{A}\\=  \hgrkb{\sigma}^\top \cmatr{A}-\cvecb{y}^\top \hmatr{A}_\Xi).
%\end{array}
%&
%\begin{array}{l}
%{\mathsf{S}_2(\crs,(\hvecb{x},\cvecb{y}),\tau_{sim})}\\
%\hline
%\vecb{z} \gets \Z_q^{\tilde{k}} \\ 
% \hgrkb{\rho}:=\matr{\Lambda} \hvecb{x}+ \hvecb{z}\\
%\cgrkb{\sigma}:=\matr{\Xi} \cvecb{y}- \cvecb{z}\\
% \text{Return }  (\hgrkb{\rho},\cgrkb{\sigma}).
%\\
%\\
%\\
%\\
%\\
%\\
%\end{array}\\
%\hline
%\end{array}$$
%\caption{Two QA-NIZK Arguments for  $\mathcal{L}_{\hmatr{M},\cmatr{N}}$. $\sps$ is 
% defined for $\widetilde{\dist_{k}}=\dist_k$ and $\tilde{k}=k+1$, and is a generalization of  
% \cite{ManualBib_EC:KilWee15}, Sect. 3.1 in two groups. The second construction $\spsws$ corresponds to $\widetilde{\dist_{k}}=\overline{\dist_k}$ and $\tilde{k}=k$, and is a generalization of   \cite{ManualBib_EC:KilWee15}, Sect. 3.2 in two groups. Computational soundness is based on the $\dist_{k}$-\skermdh{} Assumption. The CRS size is $(\tilde{k}k+2\tilde{k}t+(m+n)k)\s$ and the proof size $\tilde{k}\s$. Verification requires $2\tilde{k}k+(m+n)k$ pairing computations. \label{fig:QANIZKtwogroups} }
%\end{figure}
%
